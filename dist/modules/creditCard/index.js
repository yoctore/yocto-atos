/* yocto-atos - Yocto module to make payment with Atos - Wrapper for Sips Office Json Interface - V0.1.0 */
"use strict";function CreditCard(a,b){this.config=b||{},this.logger=a,this.api=require("../api")(logger)}var _=require("lodash"),logger=require("yocto-logger"),joi=require("joi"),Q=require("q"),utils=require("yocto-utils");CreditCard.prototype.createAuthorization=function(a){var b=Q.defer(),c=joi.object().required().keys({amount:joi.number().integer().required().min(0),captureDay:joi.number().integer().optional().min(0)["default"](6),orderChannel:joi.string().optional()["default"]("INTERNET"),captureMode:joi.string().optional()["default"]("VALIDATION"),paymentPattern:joi.string().optional()["default"]("ONE_SHOT"),cardNumber:joi.string().creditCard().required(),cardExpiryDate:joi.string().required().empty(),cardCSCValue:joi.string().required().empty(),orderId:joi.string().optional().empty(),transactionReference:joi.string().optional().empty(),interfaceVersion:joi.string().optional()["default"]("IR_WS_2.12"),fraudData:joi.object(),merchantId:joi.number().integer().required().min(0)}),d=c.validate(a);return d.error?(this.logger.error("[ YoctoAtos.CreditCard.createAuthorization.joi ] - an error occured schema is not conform, more details : "+utils.obj.inspect(d.error)),b.reject(d.error.toString()),b.promise):(a=d.value,this.logger.debug("[ YoctoAtos.CreditCard.createAuthorization ] - a new request will be send to create authorization payment"),this.api.process(this.config,"checkout/cardOrder",a,"createAuthorization",!1).then(function(a){b.resolve(a)})["catch"](function(a){this.logger.error("[ YoctoAtos.CreditCard.createAuthorization.create ] - the payment was not authorized"),b.reject(a)}.bind(this)),b.promise)},CreditCard.prototype.capturePayment=function(a){var b=Q.defer(),c=joi.object().required().keys({operationAmount:joi.number().integer().required().min(0),transactionReference:joi.string().optional().empty(),merchantId:joi.string().required().empty(),interfaceVersion:joi.string().optional()["default"]("CR_WS_2.12"),operationOrigin:joi.string().optional().empty()}),d=c.validate(a);return d.error?(this.logger.error("[ YoctoAtos.CreditCard.capturePayment.joi ] - an error occured schema is not conform, more details : "+d.error.toString()),b.reject(d.error.toString()),b.promise):(a=d.value,this.logger.debug("[ YoctoAtos.CreditCard.capturePayment ] - a new request will be send to create authorization payment"),this.api.process(this.config,"cashManagement/validate",a,"capturePayment").then(function(a){b.resolve(a)})["catch"](function(a){this.logger.error("[ YoctoAtos.CreditCard.capturePayment ] - the payment was not authorized"),b.reject(a)}.bind(this)),b.promise)},CreditCard.prototype.cancelPayment=function(a){var b=Q.defer(),c=joi.object().required().keys({operationAmount:joi.number().integer().required().min(0),s10TransactionReference:joi.object().optional().keys({s10TransactionId:joi.string().required().empty(),s10TransactionIdDate:joi.string().required().empty()}),merchantId:joi.string().required().empty(),interfaceVersion:joi.string().optional()["default"]("CR_WS_2.12"),transactionReference:joi.string().optional().empty(),operationOrigin:joi.string().optional().empty()}),d=c.validate(a);return d.error?(this.logger.error("[ YoctoAtos.CreditCard.cancelPayment.joi ] - an error occured schema is not conform, more details : "+d.error.toString()),b.reject(d.error.toString()),b.promise):(a=d.value,this.logger.debug("[ YoctoAtos.CreditCard.cancelPayment ] - a new request will be send to create authorization payment"),this.api.process(this.config,"cashManagement/cancel",a,"capturePayment").then(function(a){b.resolve(a)})["catch"](function(a){this.logger.error("[ YoctoAtos.CreditCard.cancelPayment ] - the payment was not authorized"),b.reject(a)}.bind(this)),b.promise)},module.exports=function(a,b){return(_.isUndefined(a)||_.isNull(a))&&(logger.warning("[ CreditCard.constructor ] - Invalid logger given. Use internal logger"),a=logger),new CreditCard(a,b)};